---
author: "Ben Artin"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{RSV example}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
```{r libraries, include=TRUE}
import::from(outbreakinference, outbreak.calc.cases, outbreak.calc.cum, outbreak.calc.thresholds, outbreak.predict.scalars, outbreak.predict.scalars.sim, outbreak.predict.timeseries, outbreak.predict.timeseries.sim)

import::from(reshape, melt)
import::from(dplyr, "%>%", rename, mutate, bind_rows, select, filter, group_by, ungroup, do, arrange, first, last, inner_join, matches)
import::from(mgcv, gam, mroot)
import::from(data.table, setnames)
import::from(ggplot2, ggplot, aes, theme_light, theme, element_blank, element_text, geom_ribbon, geom_point, geom_line, geom_segment, geom_violin, scale_x_continuous, scale_y_continuous, labs, coord_cartesian)
import::from(ggstance, geom_violinh)
import::from(knitr, kable)
```

Set up some utilities for plotting

```{r plot utilities, include=TRUE}
# .01 to let minor gridlines show through
epiWeekBreaks = c(3.01, 7.25, 11.75, 16.01, 20.25, 24.75, 29.01, 33.01, 37.5, 42.01, 46.25, 50.75)
epiWeekLabels = c("Jul", "Aug", "Sep", "Oct", "Nov", "Dec", "Jan", "Feb", "Mar", "Apr", "May", "Jun")

breaks.df = data.frame(i=seq(1, 12), mid=epiWeekBreaks)
monthBoundaries = breaks.df %>%
  inner_join(
    breaks.df %>% mutate(i=i %% 12 + 1) %>% rename(prevMid=mid),
    by="i"
  ) %>%
  inner_join(
    breaks.df %>% mutate(i=(i - 2) %% 12 + 1) %>% rename(nextMid=mid),
    by="i"
  ) %>%
  mutate(
    min=(prevMid + (mid - prevMid) %% 52 / 2) %% 52,
    max=mid + (nextMid - mid) %% 52 / 2
  ) %>%
  select(i, min, mid, max)

rsvPlot = function(data) {
  ggplot(data) +
    theme_light() +
    scale_y_continuous() +
    scale_x_continuous(breaks=monthBoundaries$mid, labels=epiWeekLabels, expand=c(0, 0)) + 
    labs(x=NULL, y=NULL) + 
    coord_cartesian(xlim=range(c(monthBoundaries$min, monthBoundaries$max))) +
    theme(
      panel.grid.major.x=element_blank(),
      legend.title=element_blank(),
      axis.ticks.x=element_blank(),
      axis.text.x=element_text(hjust=0.5, vjust=0.5),
      legend.position="bottom"
    )
}

```

Load RSV data from the CSV file, and calculate absolute and relative cumulative incidence. Observed cumulative incidence is used only for plotting, not for analysis.

```{r data, include=TRUE}
rsvObs = read.csv("rsv.csv")
rsvObs$rsv.cum = cumsum(rsvObs$rsv)
rsvObs$rsv.cum.frac = rsvObs$rsv.cum / max(rsvObs$rsv.cum)
```

Generate a long-linked GAM with 20-knot cubic cyclic P-splines

```{r model, include=TRUE}
rsvModel = gam(rsv ~ s(time, k=20, bs="cp", m=3), family=poisson, data=rsvObs)
```

Generate a vector of time values at which the model will be evaluated. The time step, `dt` is also used whenever model predictions require numeric integration. 

```{r model time, include=TRUE}
dt = .05
modelTime = seq(min(rsvObs$time) - 1 + dt, max(rsvObs$time), dt)
```

Generate predictions for RSV case count time  series at 95% confidence level.

```{r predict cases, include=TRUE}
n = 2000 # Number of samples from the model parameter distribution

rsvCasesPred = rsvModel %>%
  outbreak.predict.timeseries(modelTime, outbreak.calc.cases(), nsim=n) %>%
  cbind(time=modelTime)
```

Plot the prediction

```{r plot cases, include=TRUE}
rsvPlot(rsvCasesPred) +
  geom_ribbon(aes(x=time, ymin=lower, ymax=upper), fill=grey(.75)) +
  geom_point(data=rsvObs, aes(x=time, y=rsv)) +
  labs(x=NULL, y="RSV cases")
```

You can also obtain the individual splines, which can be helpful for visualization. For example, here are 15 splines generated by the same model:

```{r plot cases splines, include=TRUE}
nSmall = 15
rsvCasesSim = rsvModel %>%
  outbreak.predict.timeseries.sim(modelTime, outbreak.calc.cases(), nsim=nSmall)
  
# Prepare the data for plotting
rsvCasesSim = rsvCasesSim %>%
  data.frame() %>%
  setnames(as.character(c(1:nSmall))) %>%
  cbind(time=modelTime) %>%
  melt(c("time")) %>%
  rename(sim=variable, rsv=value)

rsvPlot(rsvCasesSim) +
  geom_line(aes(x=time, y=rsv, group=sim), color=grey(.75)) +
  geom_point(data=rsvObs, aes(x=time, y=rsv)) +
  labs(y="RSV cases")
```

Once we have a model for case counts, we can use it to calculate and visualize various outcome measures. One of the simplest is cumulative incidence:

```{r predict cum cases, include=TRUE}
rsvCumCasesPred = rsvModel %>%
  outbreak.predict.timeseries(modelTime, outbreak.calc.cum(), nsim=n) %>%
  cbind(time=modelTime)

rsvPlot(rsvCumCasesPred) +
  geom_ribbon(aes(x=time, ymin=lower, ymax=upper), fill=grey(.75)) +
  geom_point(data=rsvObs, aes(x=time, y=rsv.cum.frac)) +
  labs(x=NULL, y="Relative cumulative incidence")
```

Next, consider a more complex outcome measure: the start of RSV season, which we define as the point in time when cumulative incidence crosses the 2.5\% threshold of total number of cases. We can use the `outbreak.calc.thresholds` function built into the `outbreakpredict` package for this:

```{r predict onset, include=TRUE}
seasonThreshold=0.025
rsvOnsetPred = rsvModel %>% 
  outbreak.predict.scalars(modelTime, outbreak.calc.thresholds(onset=seasonThreshold)) %>%
  select(matches("onset."))

kable(rsvOnsetPred, caption="Estimated season onset", col.names=c("Lower CL", "Median", "Upper CL"))
```

If you are interested in the distribution of the outcome measure, rather than just the confidence intervals, you can get individual samples and plot them:

```{r plot onset distribution, include=TRUE}
rsvOnsetSim = rsvModel %>% 
  outbreak.predict.scalars.sim(modelTime, outbreak.calc.thresholds(onset=0.025), nsim=n) %>%
  select(onset, outbreak.sim)

rsvPlot(rsvCumCasesPred) +
  geom_ribbon(aes(x=time, ymin=lower, ymax=upper), fill=grey(.75)) +
  geom_segment(aes(x=-Inf, xend=Inf, y=seasonThreshold, yend=seasonThreshold), linetype="13") +
  geom_point(data=rsvObs, aes(x=time, y=rsv.cum.frac)) +
  geom_violinh(
    data=rsvOnsetSim,
    aes(x=onset, y=seasonThreshold),
    width=.1,
    fill="gray50", color="black",
    trim=FALSE, draw_quantiles=c(0.025, 0.5, 0.975)
  ) +
  labs(x=NULL, y="Relative cumulative incidence")
```

This particular infectious disease can be mitigated by use of prophylaxis, but the prophylaxis — due to its cost — is only recommended for high-risk patients during peaks of disease activity. As a result, another potentially interesting outcome measure is the fraction of cases that occur while prophylaxis is active (“preventable fraction”). Let's consider prophylaxis that is administered in week 20, and that gives protection for 24 weeks, and estimate its preventable fraction.

First, we define a function for calculating this custom otucome measure. The function takes three arguments:

 * `model`, which is the model itself
 * `params`, which is a vector of sampled model parameters and
 * `time`, which is a vector of time points at which the model is to be evaluated
 
The function calculates predicted case counts using the model, and then calculates the preventable fraction from those case counts.
 
```{r custom outcome function, include=TRUE}
ppxStart = 20 # weeks
ppxDuration = 24 # weeks
ppxEnd = ppxStart + ppxDuration

calcFraction = function(model, params, time) {
  predictors = predict(model, data.frame(time=time), type="lpmatrix")
  cases = model$family$linkinv(predictors %*% params)

  cases = data.frame(time=time, cases=cases)
  totalCases = sum(cases$cases)
  preventableCases = sum(cases$cases[cases$time >= ppxStart & cases$time <= ppxEnd])
  
  data.frame(preventable=c(preventableCases / totalCases))
}
```

Then we call the package to get an interval estimate of our custom outcome measure:

```{r custom outcome estimate, include=TRUE}
rsvPreventableFractionPred = outbreak.predict.scalars(rsvModel, modelTime, calcFraction)

kable(rsvPreventableFractionPred, caption="Estimated preventable fraction", col.names=c("Lower CL", "Median", "Upper CL"))
```

We can also look at the distribution of our custom outcome measure:

```{r custom outcome distribution, include=TRUE, fig.width=2, fig.height=6}
rsvPreventableFractionSim = outbreak.predict.scalars.sim(rsvModel, modelTime, calcFraction, nsim=n)

ggplot(rsvPreventableFractionSim) +
  theme_light() +
  scale_y_continuous() +
  scale_x_continuous() + 
  labs(x=NULL, y="Preventable fraction") + 
  coord_cartesian(ylim=range(c(0, 1))) +
  theme(
    panel.grid.major.x=element_blank(),
    legend.title=element_blank(),
    axis.ticks.x=element_blank(),
    axis.text.x=element_blank(),
    legend.position="bottom"
  ) +
  geom_violin(
    aes(x=0, y=preventable),
    width=.1,
    fill="gray50", color="black",
    trim=FALSE, draw_quantiles=c(0.025, 0.5, 0.975)
  )
```

